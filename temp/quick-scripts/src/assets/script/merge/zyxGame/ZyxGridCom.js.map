{"version":3,"sources":["assets/script/merge/zyxGame/ZyxGridCom.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import { zyxGameModule } from \"../dataModule/ZyxGameModule\";\nimport { gridContentType, gridSize } from \"../define/TypeDefine\";\nimport { EventType } from \"../manager/Define\";\nimport { uimanager } from \"../manager/Uimanager\";\nimport { eventManager } from \"../util/EventManager\";\nimport NewUtils from \"../util/NewUtils\";\n\nconst { ccclass, property } = cc._decorator;\n\n// 格子组件\n@ccclass\nexport default class ZyxGridCom extends cc.Component {\n\n    @property(cc.Node)\n    uImgDiamond: cc.Node = null;\n\n    @property(cc.Sprite)\n    uImgBg: cc.Sprite = null;\n\n    private size: gridSize = gridSize.ONE;\n    private contentType: gridContentType = gridContentType.EMPTY;\n    public uniqueId: number = 0;\n\n    private row: number = -1;\n    private col: number = -1;\n\n    // 便宜量\n    private offsetCnt: number = 0;\n\n    // 初始点击位置\n    private originX: number = 0;\n\n    // 格子原始位置\n    private originGridX: number = 0;\n\n    onLoad() {\n        this.node.on(cc.Node.EventType.TOUCH_START, this.onTouchStart, this);\n        this.node.on(cc.Node.EventType.TOUCH_MOVE, this.onTouchMove, this);\n        this.node.on(cc.Node.EventType.TOUCH_END, this.onTouchEnd, this);\n        this.node.on(cc.Node.EventType.TOUCH_CANCEL, this.onTouchEnd, this);\n    }\n\n    start() { }\n\n    init(info: [gridSize, gridContentType, number]) {\n        // 格子类型基础属性\n        this.size = info[0];\n        this.contentType = info[1];\n        this.uniqueId = info[2];\n\n        if (this.contentType === gridContentType.EMPTY) {\n            this.node.active = false;\n            return;\n        }\n\n\n        // 格子外观尺寸\n        this.node.width = 84 * info[0];\n        this.uImgBg.node.width = this.node.width;\n        this.uImgBg.node.x = this.uImgBg.node.width / 2;\n        this.uImgDiamond.x = this.uImgBg.node.width / 2;\n        this.uImgDiamond.active = this.contentType === gridContentType.DIAMOND;\n\n        const skinUrl = `images/grid/color_${NewUtils.randomIntInclusive(1, 13)}`;\n        NewUtils.setSpriteFrameByUrl(this.uImgBg, skinUrl);\n    }\n\n    setRowCel(row: number, col: number) {\n        this.row = row;\n        this.col = col;\n    }\n\n    moveUp() {\n        this.row -= 1;\n    }\n\n    moveDown() {\n        this.row += 1;\n    }\n\n    // 删除\n    eliminate(): void {\n        cc.tween(this.node)\n            .to(0.3, { opacity: 0 })\n            .call(() => {\n                this.node.removeFromParent();\n            })\n            .start();\n    }\n\n    onTouchStart(e) {\n        if (zyxGameModule.lock) return;\n        zyxGameModule.lock = true;\n        console.log(\"onTouchStart\", this.uniqueId, e.touch.getLocation().x);\n        this.originX = e.touch.getLocation().x;\n        this.originGridX = this.node.x;\n        this.offsetCnt = 0;\n    }\n\n    onTouchMove(e): void {\n        const dx = e.touch.getLocation().x - this.originX;\n\n        const canMove = this.checkMove(dx);\n        if (canMove) {\n            this.node.opacity = 255;\n            this.node.x = this.originGridX + zyxGameModule.gridsWidth * this.offsetCnt;\n        } else {\n            this.node.opacity = 100;\n        }\n    }\n\n    onTouchEnd(e) {\n        console.log(\"onTouchEnd\", this.uniqueId);\n        const dx = e.touch.getLocation().x - this.originX;\n        let canMove = this.checkMove(dx);\n\n        this.node.opacity = 255;\n\n        if (canMove) {\n            this.moveCrossWise();\n        } else {\n            this.node.x = this.originGridX;\n        }\n    }\n\n    // 检测是否可以移动, 标记状态\n    checkMove(dx: number): boolean {\n        // 实际上操作的位移格子空间\n        const offsetCnt = Math.floor(Math.abs(dx) / zyxGameModule.gridsWidth);\n\n        // 理论上最大允许发生的最大位移空间\n        const rowData = zyxGameModule.gridInfo[this.row];\n        let maxOffsetCnt = 0;\n        if (dx > 0) {\n            // 向右移动\n            for (let i = this.col + this.size; i < 8; i++) {\n                if (rowData[i][1] !== gridContentType.EMPTY) {\n                    break;\n                }\n                maxOffsetCnt++;\n            }\n        } else {\n            // 向左移动\n            for (let i = this.col - 1; i >= 0; i--) {\n                if (rowData[i][1] !== gridContentType.EMPTY) {\n                    break;\n                }\n                maxOffsetCnt++;\n            }\n        }\n\n        console.log(`方向:${dx / Math.abs(dx) > 0 ? '右' : '左'} 拖动: ${offsetCnt}, 最大: ${maxOffsetCnt}`);\n        if (Math.abs(offsetCnt) <= maxOffsetCnt) {\n            this.offsetCnt = dx / Math.abs(dx) * offsetCnt;\n            return true;\n        } else {\n            this.offsetCnt = dx / Math.abs(dx) * maxOffsetCnt;\n            return false;\n        }\n    }\n\n    // 实际发生横向移动\n    moveCrossWise(): void {\n        if (this.offsetCnt === 0) return;\n        if (this.offsetCnt > 0) {\n            uimanager.showTips(`右 -> ${this.offsetCnt}`);\n        } else {\n            uimanager.showTips(`左移 <- ${-this.offsetCnt}`);\n        }\n\n        // 挪走的位置置为空\n        for (let col = this.col; col < this.col + this.size; col++) {\n            zyxGameModule.gridInfo[this.row][col] = [0, 0, 0];\n        }\n\n        // 新的位置 置为当前格子\n        const newStartCol = this.col + this.offsetCnt;\n        const newEnd = newStartCol + this.size;\n        for (let col = newStartCol; col < newEnd; col++) {\n            zyxGameModule.gridInfo[this.row][col][0] = this.size;\n            zyxGameModule.gridInfo[this.row][col][1] = this.contentType;\n            zyxGameModule.gridInfo[this.row][col][2] = this.uniqueId;\n        }\n\n        // update col\n        this.setRowCel(this.row, this.col + this.offsetCnt);\n        this.originGridX = this.node.x;\n\n        eventManager.dispatch(EventType.ZYX_CHECK_MERGE);\n        console.log(`第${this.row}行：`, zyxGameModule.gridInfo);\n    }\n}\n"]}